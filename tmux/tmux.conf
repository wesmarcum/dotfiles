### Get tmux version
run-shell 'tmux setenv -g TMUX_VERSION $(tmux -V | \
                           sed -En "s/^tmux[^0-9]*([.0-9]+).*/\1/p")'

### Copy/Paste options

# Vi copypaste mode
set-window-option -g mode-keys vi
bind P paste-buffer

bind-key -T copy-mode-vi 'v' send -X begin-selection; \
bind-key -T copy-mode-vi 'V' send -X select-line; \
bind-key -T copy-mode-vi 'r' send -X rectangle-toggle; \
bind-key -T copy-mode-vi 't' send -X copy-pipe-and-cancel 'xargs task +do +work due:eod add'; \
bind-key -T copy-mode-vi 'y' send -X copy-pipe-and-cancel 'xclip -in -selection clipboard'

# v2.4 and above
# if-shell -b '[ "$(echo "$TMUX_VERSION >= 2.4" | bc)" = 1 ]' \
  # "bind-key -T copy-mode-vi 'v' send -X begin-selection; \
  # bind-key -T copy-mode-vi 'V' send -X select-line; \
  # bind-key -T copy-mode-vi 'r' send -X rectangle-toggle; \
  # bind-key -T copy-mode-vi 't' send -X copy-pipe-and-cancel 'xargs task +do +work due:eod add'; \
  # bind-key -T copy-mode-vi 'y' send -X copy-pipe-and-cancel 'xclip -in -selection clipboard'"

# v2.3 and below
# if-shell -b '[ "$(echo "$TMUX_VERSION < 2.4" | bc)" = 1 ]' " \
    # bind-key -t vi-copy 'v' begin-selection; \
    # bind-key -t vi-copy 'y' copy-selection"

### Keybindings

# set prefix to Ctrl-a
unbind C-b
set-option -g prefix C-a
bind-key C-a send-prefix

# hjkl pane traversal
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# split panes using | and -
bind | split-window -h
bind - split-window -v
unbind '"'
unbind %

# bind alt-a, alt-s keys to monitor activity, silence
bind-key M-a set-window-option monitor-activity on  \; display "Monitoring window for activity"
bind-key M-A set-window-option monitor-activity off \; display "NOT monitoring window for activity"
bind-key M-s set-window-option monitor-silence 15   \; display "Monitoring window for silence"
bind-key M-S set-window-option monitor-silence 0    \; display "NOT monitoring window for silence"

### Global options

# enable passthrough for term shortcuts (ctrl, shift)
set-window-option -g xterm-keys on

# global activity monitoring - disable activity and silence monitoring by default
setw -g monitor-activity off
setw -g monitor-silence 0
set -g visual-activity off
set -g visual-bell off
set -g visual-silence off

# reload config file (change file location to your the tmux.conf you want to use)
bind r source-file ~/.tmux.conf \; display-message "Config reloaded..."

# don't rename windows automatically
# set-option -g allow-rename off

### Mouse

# Enable mouse mode
set -g mouse on

# Enable mouse mode (tmux 2.1 and above)
# if-shell -b '[ "$(echo "$TMUX_VERSION >= 2.1" | bc)" = 1 ]' \
  # "set -g mouse on"

# mouse mode (tmux < 2.1)
# if-shell -b '[ "$(echo "$TMUX_VERSION < 2.1" | bc)" = 1 ]' " \
    # set -g mouse-select-pane on; set -g mode-mouse on; \
    # set -g mouse-resize-pane on; set -g mouse-select-window on"

### Term Colors

# How to use true colors in vim under tmux? #1246 for 2.6 and higher
# https://github.com/tmux/tmux/issues/1246:
# set -g default-terminal "tmux-256color"
# set -ga terminal-overrides ",*256col*:Tc"
# 2.5 and lower:
# set -g default-terminal "screen-256color"

# Doesn't work on iterm2 / mac
# if-shell "test '\( #{$TMUX_VERSION_MAJOR} -eq 2 -a #{$TMUX_VERSION_MINOR} -ge 6 \)'" 'set -g default-terminal "tmux-256color"'
# if-shell "test '\( #{$TMUX_VERSION_MAJOR} -eq 2 -a #{$TMUX_VERSION_MINOR} -ge 6 \)'" 'set -ga terminal-overrides ",*256col*:Tc"'

# Try screen256-color (https://github.com/tmux/tmux/issues/622):
if-shell "test '\( #{$TMUX_VERSION_MAJOR} -eq 2 -a #{$TMUX_VERSION_MINOR} -ge 6 \)'" 'set -g default-terminal "screen-256color"'
if-shell "test '\( #{$TMUX_VERSION_MAJOR} -eq 2 -a #{$TMUX_VERSION_MINOR} -ge 6 \)'" 'set -ga terminal-overrides ",screen-256color:Tc"'

if-shell '\( #{$TMUX_VERSION_MAJOR} -eq 2 -a #{$TMUX_VERSION_MINOR} -lt 6\) -o #{$TMUX_VERSION_MAJOR} -le 1' 'set -g default-terminal "screen-256color"'

### Styling

# Simple status line, default with color change.
set -g status-interval 2
set -g status-style 'fg=blue bg=black'
set -g status-left "S:#S | #[default]"
set -g status-left-length 25

# Messages.
set -g message-style 'fg=black bg=blue bold'
set -g message-command-style 'fg=blue bg=black bold'

# Window lists.
set -wg mode-style 'fg=black bg=blue'

### Nested sessions

# This section enables a hotkey (F12) to toggle the prefix key.
# Useful when you want to disable the prefix key on an outer session.

# Activate OFF mode - F12
bind -T root F12 \
    set prefix None \;\
    set key-table off \;\
    set status-left "S:#S #[fg=black,bg=blue]OFF#[fg=blue,bg=black] | #[default]"

# Disable OFF mode - F12
bind -T off F12 \
    set -u prefix \;\
    set -u key-table \;\
    set -u status-style \;\
    set -u status-left
